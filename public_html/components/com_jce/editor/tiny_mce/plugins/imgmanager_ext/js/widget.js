/* imgmanager_ext - 2.1.2 | 15 August 2016 | http://www.joomlacontenteditor.net | Copyright (C) 2006 - 2016 Ryan Demmer. All rights reserved | GNU/GPL Version 2 - http://www.gnu.org/licenses/gpl-2.0.html */
if(typeof ImageManagerDialog==="undefined"){ImageManagerDialog={insert:function(){var win=tinyMCEPopup.getWindowArg("window");var src=$('#src').val();if(src===""){var selected=WFFileBrowser.getSelectedItems();if(selected.length){this.selectFile(selected[0]);src=$('#src').val();}}
win.document.getElementById(tinyMCEPopup.getWindowArg("input")).value=src;tinyMCEPopup.close();},close:function(){tinyMCEPopup.close();},selectFile:function(file){var name=file.title;var src=$(file).data('url');src=src.charAt(0)=='/'?src.substring(1):src;$('#src').val(src);}};}
(function($,tinyMCEPopup,ImageManagerDialog){$.support.canvas=!!document.createElement('canvas').getContext;var ImageManagerWidget={init:function(settings){var self=this;self.mode=$.Cookie.get('wf_imgmanager_ext_mode')||settings.view_mode;self.settings=settings||{};WFFileBrowser.init($('#src'),{onFileClick:function(e,file){ImageManagerDialog.selectFile(file);},onFileInsert:function(e,file){ImageManagerDialog.selectFile(file);},onBeforeBuildList:function(){self.onBeforeBuildList();},onAfterBuildList:function(){self.onAfterBuildList();},onPaste:function(){self.onAfterBuildList();},onInit:function(){$('#show-details').click(function(e){if(self.mode==='images'){self._createPreviewThumbnails();self._createBrowserSlider();}else{$('#browser-list-resize').hide();}
if(!$('#browser').hasClass('full-width')){$('#browser-list-resize').hide();$('li.file.thumbnail-preview','#item-list').width(50).height(50);}});},onSelectItems:function(items){var $list=$('li.file.selected','#item-list');if($list.length==1){if($('#src').is(':disabled')){ImageManagerDialog.selectFile($list[0]);}}},onRemoveItems:function(items){var $list=$('li.file.selected','#item-list');if($list.length==1){if($('#src').is(':disabled')){ImageManagerDialog.selectFile($list[0]);}}},createThumbnail:function(){self._createThumbnail();},editImage:function(){self._editImage();},deleteThumbnail:function(){self._deleteThumbnail();},switchMode:function(){self.switchMode();},selectMultiple:function(){ImageManagerDialog.selectMultiple();},onUploadOpen:function(){self._getUploadOptions();},onUpload:function(event,data){var s=self.settings.defaults;if($('#upload_resize_state').is(':checked')){var w=$('#upload_resize_width').val(),h=$('#upload_resize_height').val();if(w||h){data.resize={width:parseInt(w),height:parseInt(h),quality:parseInt(s.resize_quality)||100};}}},onUploadFile:function(event,file){},onFileDetails:function(){$('#info-thumbnail').remove();},onListSort:function(){self._createPreviewThumbnails();},onMaximise:function(){self._createPreviewThumbnails();},onUploadComplete:function(){if($.isFunction(WFFileBrowser.addListItem)){var selected=$('#item-list li.file.selected').map(function(){return{name:$(this).attr('title')};});WFFileBrowser.load($.makeArray(selected));}},upload:{required:['multipart','jpgresize','pngresize'],canvasResize:false}});},onBeforeBuildList:function(){if(this.mode==='images'){$('li.file','#item-list').hide();}},onAfterBuildList:function(){if(this.mode==='images'){this.togglePreviewThumbnails();}},_loadPreviewThumbnail:function(item){var self=this,id=$(item).attr('id');var src=$(item).data('preview');if(!src){src=$.String.path($.Plugin.getURI(),$(item).data('url'));$(item).data('preview',src);}
if($(item).data('thumbnail')){src=$.String.path($.Plugin.getURI(),$(item).data('thumbnail'));}
var img=new Image();var x=0;$(item).addClass('thumbnail-loading');$(img).load(function(){var v=$('#browser-list-resize').slider('value')*5;var span=$('span.thumbnail',item).get(0);if(!span){span=$('<span/>').addClass('thumbnail').prependTo(item);}
if($.support.backgroundSize){$(span).css('background-image','url("'+img.src+'")');if(img.width>55||img.height>55){$(span).addClass('resize');}}else{if(tinymce.isIE){$(span).css('background-image','none');$(span).get(0).runtimeStyle.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(src='"+img.src+"',sizingMethod='scale')";}}
$(item).removeClass('thumbnail-loading').addClass('thumbnail-loaded').css({width:v,height:v});});$(img).bind('error.local',function(){$(item).removeClass('thumbnail-loading').addClass('thumbnail-error');});if(this.settings.canEdit&&this.settings.cache_enable&&!$(item).data('thumbnail')){var args={'action':'thumbnail','img':$(item).attr('id')};var fields=$(':input','form').serializeArray();$.each(fields,function(i,field){args[field.name]=field.value;});src=tinyMCEPopup.getParam('site_url')+'index.php?option=com_jce&view=editor&layout=plugin&plugin=imgmanager_ext&'+$.param(args);$(img).unbind('error.local').bind('error.server',function(){$(this).unbind('error.server').bind('error.local',function(){$(item).removeClass('thumbnail-loading').addClass('thumbnail-error');});src=$(item).data('preview');if($(item).data('thumbnail')){src=$.String.path($.Plugin.getURI(),$(item).data('thumbnail'));}
img.src=src;});}
img.src=src;},_createPreviewThumbnails:function(force){var self=this;var area=$('#browser-list').height()+$('#browser-list').scrollTop();var selector=!force?'.thumbnail-loading, .thumbnail-loaded, .thumbnail-error':'.thumbnail-loading';$('#item-list li.file').not(selector).each(function(){var pos=$(this).position();if(pos.top<area){self._loadPreviewThumbnail(this);}});},togglePreviewThumbnails:function(force){var self=this,$list=$('li.file','#item-list'),s=this.mode==='images';$list.toggleClass('thumbnail-preview',s);$('#browser-list-resize','div.full-width').toggle(s);$('span',$list).not('span.checkbox').attr('aria-hidden',s);$('span.thumbnail',$list).attr('aria-hidden',!s);if(s){$('#item-list').bind('click.item-list-images',function(e){var n=e.target;if($(n).is('li.file, span.thumbnail')){e.stopImmediatePropagation();var file=$(n).is('li.file')?n:$(n).parent('li.file');ImageManagerDialog.selectFile(file);}});if($('#browser').hasClass('full-width')){self._createBrowserSlider();}
this._createPreviewThumbnails(force);$('#browser-list').bind('scroll.browser-list',function(e){self._createPreviewThumbnails();});if($('#item-list').data('sortable')){$('#item-list').sortable('option','axis',false);}}else{$('#browser-list').unbind('scroll.browser-list');$('#item-list').unbind('click.item-list-images');$('#browser-list-resize').hide();$list.removeAttr('style');if($('#item-list').data('sortable')){$('#item-list').sortable('option','axis','y');}}},_createBrowserSlider:function(){if(!document.getElementById('browser-list-resize')){$('ul.limit-right','#browser-list-limit').before('<div id="browser-list-resize" class="slider"><span class="slider-image-left" /><span class="slider-image-right" /></div>');$('#browser-list-resize').slider({min:11,max:22,slide:function(event,ui){var v=ui.value*5;$('#item-list li.file.thumbnail-preview').css({width:v,height:v});}});}
var v=$('#browser-list-resize').show().slider('value')*5;$('#item-list li.file.thumbnail-preview').width(v).height(v);},setMode:function(){$('#view_mode').toggleClass('images',(this.mode==='images'));},switchMode:function(){this.mode=(this.mode==='images')?'list':'images';$('#view_mode').toggleClass('images',(this.mode==='images'));$.Cookie.set('wf_imgmanager_ext_mode',this.mode);this.togglePreviewThumbnails(true);},_deleteThumbnail:function(){var item=WFFileBrowser.getSelectedItems(0);$.Dialog.confirm(tinyMCEPopup.getLang('imgmanager_ext_dlg.delete_thumbnail','Delete Thumbnail?'),function(state){if(state){var id=$(item).attr('id');WFFileBrowser.status(tinyMCEPopup.getLang('imgmanager_ext_dlg.delete_thumbnail_message','Deleting Thumbnail...'),'load');$.JSON.request('deleteThumbnail',[id],function(o){if(o.error.length){WFFileBrowser.error(o.error);}
WFFileBrowser.load(id);});}});},_createThumbnail:function(){var self=this;var item=WFFileBrowser.getSelectedItems(0);$.Dialog.dialog(tinyMCEPopup.getLang('imgmanager_ext_dlg.create_thumbnail','Create Thumbnail'),'',{text:tinyMCEPopup.getLang('dlg.name','Name'),id:'thumbnail-create-dialog',width:680,height:420,dialogClass:'thumbnail',onOpen:function(){$('#thumbnail-create-dialog').thumbnail({src:$(item).data('preview')+'?'+new Date().getTime(),values:self.settings.defaults,toDataURL:self.settings.image_engine=='canvas'});},buttons:[{text:$.Plugin.translate('save','Save'),click:function(){var data=$('#thumbnail-create-dialog').thumbnail('save');var args={json:[$(item).attr('id')]};$.merge(args.json,[data.width,data.height,data.quality,data.sx,data.sy,data.sw,data.sh]);WFFileBrowser.status(tinyMCEPopup.getLang('imgmanager_ext_dlg.create_thumbnail_message','Creating Thumbnail...'),'load');$.JSON.request('createThumbnail',args,function(o){if(o&&o.error&&o.error.length){WFFileBrowser.error(o.error);}
WFFileBrowser.load($(item).attr('id'));},self);$(this).dialog('close');}}]});},_editImage:function(){var self=this;var item=WFFileBrowser.getSelectedItems(0);var ed=tinyMCEPopup.editor,vp=tinymce.DOM.getViewPort();var iw=parseFloat($(item).data('width')),ih=parseFloat($(item).data('height'));var ww=vp.w-60;var wh=vp.h-80;var src=$(item).attr('id');var win=ed.windowManager.open({url:ed.getParam('site_url')+'index.php?option=com_jce&view=editor&layout=plugin&plugin=imgmanager_ext&dialog=editor',width:ww,height:wh,min_width:ww,min_height:wh,close_previous:false,inline:true},{src:src,width:iw,height:ih,base:WFFileBrowser.getBaseDir(),save:function(item){WFFileBrowser.load({name:item});},scope:this});},_getUploadOptions:function(){var self=this,s=this.settings.defaults;var $resize=$('<div class="row" id="upload_resize_options">'+'<input id="upload_resize_state" name="upload_resize_state" type="checkbox" checked="checked" value="1" /><label for="upload_resize" title="'+tinyMCEPopup.getLang('imgmanager_ext_dlg.upload_resize_tip','Resize')+'" class="hastip">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.resize','Resize')+'</label>'+'<label for="upload_resize_width">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.width','Width')+'</label>'+'<input type="text" id="upload_resize_width" name="upload_resize_width" class="width" value="" /> px'+'<label for="upload_resize_height">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.height','Height')+'</label>'+'<input type="text" id="upload_resize_height" name="upload_resize_height" value="" class="height" /> px'+'<div id="upload_resize_constrain" class="constrain"><span class="checkbox checked" aria-checked="true" role="checkbox"></span></div>'+'</div>');var $thumbnail=$('<div class="row" id="upload_thumbnail_options">'+'<input id="upload_thumbnail_state" name="upload_thumbnail_state" type="checkbox" checked="checked" value="1" /><label for="upload_thumbnail" title="'+tinyMCEPopup.getLang('imgmanager_ext_dlg.upload_thumbnail_tip','Thumbnail')+'" class="hastip">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.thumbnail','Thumbnail')+'</label>'+'<label for="upload_thumbnail_width">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.width','Width')+'</label>'+'<input type="text" id="upload_thumbnail_width" name="upload_thumbnail_width" class="width" value="" /> px'+'<label for="upload_thumbnail_height">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.height','Height')+'</label>'+'<input type="text" id="upload_thumbnail_height" name="upload_thumbnail_height" value="" class="height" /> px'+'<input type="checkbox" id="upload_thumbnail_crop" name="upload_thumbnail_crop" value="" />'+'<label for="upload_thumbnail_crop" title="'+tinyMCEPopup.getLang('imgmanager_ext_dlg.upload_thumbnail_crop_tip','Crop To Fit')+'" class="hastip">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.upload_thumbnail_crop','Crop To Fit')+'</label>'+'<div id="upload_thumbnail_constrain" class="constrain"><span class="checkbox checked" aria-checked="true" role="checkbox"></span></div>'+'</div>');var $watermark=$('<div class="row" id="upload_watermark_options">'+'<input id="upload_watermark_state" name="upload_watermark_state" type="checkbox" value="0" />'+'<label for="upload_watermark_state" title="'+tinyMCEPopup.getLang('imgmanager_ext_dlg.upload_watermark_tip','Watermark')+'" class="hastip">'+tinyMCEPopup.getLang('imgmanager_ext_dlg.watermark','Watermark')+'</label></div>');$('<div id="upload-transform"/>').insertAfter('#upload-queue-block').hide();var rw=s.upload_resize_width;var rh=s.upload_resize_height;var tw=s.thumbnail_width;var th=s.thumbnail_height;if(tw===''&&th===''){tw=120,th=90;}
if(rw===''&&rh===''){rw=640,rh=480;}
if(!!s.upload_resize){$('#upload-transform').append($resize);$('#upload_resize_width').val(rw).data('tmp',rw).change(function(){var w=$(this).val(),$height=$('#upload_resize_height');if(w&&$height.val()){if($('#upload_resize_constrain span.checkbox').is('.checked')){var tw=$(this).data('tmp'),h=$height.val();if(tw){var temp=((h/tw)*w).toFixed(0);$height.val(temp).data('tmp',temp);}}}
$(this).data('tmp',w);});$('#upload_resize_height').val(rh).data('tmp',rh).change(function(){var h=$(this).val(),$width=$('#upload_resize_width');if(h&&$width.val()){if($('#upload_resize_constrain span.checkbox').is('.checked')){var th=$(this).data('tmp'),w=$width.val();if(th){var temp=((w/th)*h).toFixed(0);$width.val(temp).data('tmp',temp);}}}
$(this).data('tmp',h);});$('#upload_resize_state').prop('checked',!!parseInt(s.upload_resize_state)).click(function(){this.value=this.checked?1:0;});}
if(!!s.upload_thumbnail&&this.settings.canEdit){$('#upload-transform').append($thumbnail);$('#upload_thumbnail_width').val(tw).data('tmp',tw).change(function(){var w=$(this).val(),$height=$('#upload_thumbnail_height');if(w&&$height.val()){if($('#upload_thumbnail_constrain span.checkbox').is('.checked')){var tw=$(this).data('tmp'),h=$height.val();if(tw){var temp=((h/tw)*w).toFixed(0);$height.val(temp).data('tmp',temp);}}}
$(this).data('tmp',w);});$('#upload_thumbnail_height').val(th).data('tmp',th).change(function(){var h=$(this).val(),$width=$('#upload_thumbnail_width');if(h&&$width.val()){if($('#upload_thumbnail_constrain span.checkbox').is('.checked')){var th=$(this).data('tmp'),w=$width.val();if(th){var temp=((w/th)*h).toFixed(0);$width.val(temp).data('tmp',temp);}}}
$(this).data('tmp',h);});$('#upload_thumbnail_state').prop('checked',!!parseInt(s.upload_thumbnail_state)).val(parseInt(s.upload_thumbnail_state)).click(function(){this.value=this.checked?1:0;});$('#upload_thumbnail_crop').prop('checked',!!parseInt(s.upload_thumbnail_crop)).val(parseInt(s.upload_thumbnail_crop)).click(function(){this.value=this.checked?1:0;});}
if(!!s.upload_watermark&&this.settings.canEdit){$('#upload-transform').append($watermark);$('#upload_watermark_state').prop('checked',!!parseInt(s.upload_watermark_state)).val(parseInt(s.upload_watermark_state)).click(function(){this.value=this.checked?1:0;});}
if(s.upload_resize||(s.upload_thumbnail&&this.settings.canEdit)){$('#upload-transform').show();$('label.hastip','#upload-transform').tips();$('span.checkbox','#upload-transform').click(function(){$(this).toggleClass('checked').attr('aria-checked',$(this).is('.checked'));});$('div.constrain','#upload-transform').each(function(){var w=$(this).siblings('input:text').get(1).offsetLeft-$(this).siblings('input:text').get(0).offsetLeft;$(this).css({'width':w,'margin-left':$(this).siblings('input:text:first').width()/2});});}
$('#upload-body').parent().dialog('option','position','center').dialog('option','width',520);}};window.ImageManagerWidget=window.WFBrowserWidget=ImageManagerWidget;})(jQuery,tinyMCEPopup,ImageManagerDialog);